<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>資產複利增長計算器 - 終極版 + 動態背景</title>
<style>
  :root{--bg:#f0f8ff;--card:rgba(255,255,255,0.96);--text:#0a2d4a;--input:#fff;--accent:#ff6d00;--accent-l:#ff8a3d;}
  body.dark{--bg:#0a1422;--card:rgba(15,25,45,0.97);--text:#e3f2fd;--input:rgba(40,60,100,0.9);--accent:#ff8a3d;--accent-l:#ffb74d;}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  body{font-family:"SF Pro TC","Microsoft JhengHei",sans-serif;color:var(--text);min-height:100vh;padding:20px 0;transition:background .6s,color .6s;overflow-x:hidden;}
  .container{max-width:1000px;margin:0 auto;background:var(--card);border-radius:32px;padding:40px 20px 60px;box-shadow:0 25px 80px rgba(0,0,0,.18);backdrop-filter:blur(20px);position:relative;z-index:2;}
  h1{font-size:2.4rem;font-weight:900;background:linear-gradient(90deg,var(--accent),var(--accent-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;margin-bottom:8px;}
  .subtitle{text-align:center;opacity:.9;margin-bottom:30px;}
  .controls{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin:30px 0 25px;}
  select,.mode-btn{padding:11px 20px;border:none;border-radius:50px;background:var(--input);color:var(--text);font-weight:600;min-width:120px;}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:18px;margin:35px 12px;}
  label{font-weight:700;color:var(--accent);margin-bottom:8px;display:block;}
  input{
    width:100%;height:56px;padding:0 18px;font-size:1.1rem;font-weight:600;
    border:none;border-radius:18px;background:var(--input);box-shadow:0 8px 25px rgba(0,0,0,.1);
    -webkit-user-modify:read-write-plaintext-only;-webkit-text-fill-color:var(--text);caret-color:transparent;outline:none;
  }
  input.active{caret-color:var(--text);}
  .calc-btn{display:block;margin:45px auto 40px;padding:18px 60px;font-size:1.55rem;font-weight:900;color:#fff;background:linear-gradient(45deg,var(--accent),var(--accent-l));border:none;border-radius:50px;box-shadow:0 15px 40px rgba(255,109,0,.5);cursor:pointer;position:relative;overflow:hidden;transition:transform .2s;}
  .calc-btn:active,#reverseCalc:active{transform:scale(0.94);}
  .calc-btn::after,#reverseCalc::after{content:'';position:absolute;border-radius:50%;background:rgba(255,255,255,.5);width:0;height:0;left:var(--ripple-x,50%);top:var(--ripple-y,50%);transform:translate(-50%,-50%);pointer-events:none;}
  .calc-btn.clicked::after,#reverseCalc.clicked::after{animation:ripple .6s ease-out;width:300px;height:300px;}
  @keyframes ripple{to{width:300px;height:300px;opacity:0;}}
  #result{text-align:center;font-size:2.1rem;font-weight:900;margin:30px 20px;line-height:1.6;}
  #finalNum{background:linear-gradient(90deg,var(--accent),var(--accent-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.35em;}
  .table-container{margin:20px 10px 40px;border-radius:20px;overflow:hidden;box-shadow:0 15px 40px rgba(0,0,0,.18);}
  .table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  table{width:100%;min-width:660px;border-collapse:collapse;background:var(--input);}
  th{background:linear-gradient(90deg,var(--accent),var(--accent-l));color:white;padding:16px 10px;white-space:nowrap;}
  td{padding:14px 10px;text-align:right;white-space:nowrap;}
  tr:nth-child(even){background:rgba(0,0,0,.04);}
  body.dark tr:nth-child(even){background:rgba(255,255,255,.06);}
  .highlight td{font-weight:900;font-size:1.05em;background:rgba(255,109,0,.18)!important;color:var(--accent);}
  .summary-row{font-weight:900!important;color:var(--accent)!important;}
  body.dark .summary-row{background:rgba(255,141,61,.25)!important;}
  @media(max-width:480px){.container{padding:35px 16px 50px;}h1{font-size:2.1rem;}#result{font-size:1.85rem;}.calc-btn{padding:16px 50px;font-size:1.45rem;}input{height:52px;}}

  /* 數字鍵盤 */
  #numPad{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-radius:28px 28px 0 0;box-shadow:0 -10px 40px rgba(0,0,0,.25);padding:20px 15px 30px;transform:translateY(100%);transition:transform .35s cubic-bezier(0.22,1,0.36,1);z-index:9999;backdrop-filter:blur(20px);}
  #numPad.show{transform:translateY(0);}
  .pad-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;max-width:420px;margin:0 auto;}
  .pad-btn{height:64px;border-radius:20px;background:var(--input);color:var(--text);font-size:1.6rem;font-weight:700;border:none;box-shadow:0 6px 18px rgba(0,0,0,.12);transition:all .2s;}
  .pad-btn:active{transform:scale(0.92);background:var(--accent);color:#fff;}
  .pad-btn.del{background:#ff4444;color:#fff;font-size:1.3rem;}
  .pad-btn.zero{grid-column:span 2;}
  .pad-btn.done{background:linear-gradient(45deg,var(--accent),var(--accent-l));color:#fff;font-weight:900;}

  /* 動態流體粒子背景 */
  #fluid-bg{position:fixed;inset:0;z-index:-1;}
</style>
</head>
<body>

<!-- 動態背景 Canvas -->
<canvas id="fluid-bg"></canvas>

<div class="container">
  <h1>資產複利增長計算器</h1>
  <p class="subtitle">財富從現在開始看見</p>

  <div class="controls">
    <select id="currency"><option value="HKD">HK$ 港幣</option><option value="USD">USD 美金</option></select>
    <select id="timeUnit"><option value="year">年</option><option value="month">個月</option><option value="week">週</option></select>
    <button class="mode-btn" id="darkBtn">暗黑模式</button>
  </div>

  <div class="grid">
    <div><label>當前資產</label><input type="number" id="initial" value="500000"></div>
    <div><label>預期年回報率 (%)</label><input type="number" id="rate" step="0.1" value="8"></div>
    <div><label>每期定投金額</label><input type="number" id="periodicAdd" value="10000"></div>
    <div><label>預測時間（正向）</label><input type="number" id="timeValue" min="1" value="20"></div>
    <div><label>目標資產（反向）</label><input type="number" id="targetAmount" value="10000000" placeholder="例如 1000萬"></div>
    <div style="display:flex;align-items:end;">
      <button class="calc-btn" id="reverseCalc" style="margin:0;padding:16px 20px;font-size:1.3rem;width:100%;">計算需要多久達到目標</button>
    </div>
  </div>

  <button class="calc-btn" id="normalCalc">立即計算詳細報表(正向)</button>
  
  <div id="result">請選擇模式開始計算</div>
  
  <div class="table-container" id="tableContainer" style="display:none;">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>期數</th><th>時間</th><th>期初金額</th><th>本期投入</th><th>本期收益</th><th>期末金額</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 數字鍵盤 -->
<div id="numPad">
  <div class="pad-grid">
    <button class="pad-btn">1</button><button class="pad-btn">2</button><button class="pad-btn">3</button><button class="pad-btn del">backspace</button>
    <button class="pad-btn">4</button><button class="pad-btn">5</button><button class="pad-btn">6</button><button class="pad-btn">000</button>
    <button class="pad-btn">7</button><button class="pad-btn">8</button><button class="pad-btn">9</button><button class="pad-btn done">完成</button>
    <button class="pad-btn">.</button><button class="pad-btn zero">0</button><button class="pad-btn">00</button><button class="pad-btn" style="visibility:hidden"></button>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const C = {HKD:{s:'HK$',r:1}, USD:{s:'US$',r:7.8}};
let fmtCache = new Map();

function fmt(n){
  const key = Math.round(n)+$('currency').value;
  if(fmtCache.has(key)) return fmtCache.get(key);
  const cur = $('currency').value;
  const val = cur==='USD'?Math.round(n/7.8):Math.round(n);
  const result = C[cur].s + val.toLocaleString('en-HK');
  fmtCache.set(key,result);
  if(fmtCache.size>1000) fmtCache.clear();
  return result;
}

const unitInfo = {year:{text:'年',perYear:1,rateDiv:1},month:{text:'個月',perYear:12,rateDiv:12},week:{text:'週',perYear:52,rateDiv:52}};

function save(){localStorage.setItem('w',JSON.stringify({
  initial:$('initial').value,rate:$('rate').value,timeValue:$('timeValue').value,
  periodicAdd:$('periodicAdd').value,targetAmount:$('targetAmount').value,
  currency:$('currency').value,timeUnit:$('timeUnit').value,
  dark:document.body.classList.contains('dark')
}));}

function load(){
  try{const d=JSON.parse(localStorage.getItem('w')||'null');
    if(d){
      $('initial').value=d.initial??500000;
      $('rate').value=d.rate??8;
      $('timeValue').value=d.timeValue??20;
      $('periodicAdd').value=d.periodicAdd??10000;
      $('targetAmount').value=d.targetAmount??10000000;
      $('currency').value=d.currency??'HKD';
      $('timeUnit').value=d.timeUnit??'year';
      if(d.dark) document.body.classList.add('dark');
    }
  }catch(e){}
}

// 正向計算
let lastCalcKey='';
function calc(){
  const key=[$('initial').value,$('rate').value,$('timeValue').value,$('periodicAdd').value,$('timeUnit').value,$('currency').value].join('|');
  if(key===lastCalcKey) return;
  lastCalcKey=key; fmtCache.clear(); save();

  const initial=Math.max(0,+($('initial').value)||0);
  const annualRate=(+($('rate').value)||0)/100;
  const periods=Math.max(1,+($('timeValue').value)||1);
  const add=Math.max(0,+($('periodicAdd').value)||0);
  const unit=unitInfo[$('timeUnit').value];
  const ratePerPeriod=annualRate/unit.rateDiv;

  let balance=initial,totalInvested=initial;
  const fragment=document.createDocumentFragment();
  const startRow=document.createElement('tr');
  startRow.innerHTML=`<td>—</td><td>起始</td><td>${fmt(initial)}</td><td>—</td><td>—</td><td>${fmt(initial)}</td>`;
  fragment.appendChild(startRow);

  for(let i=1;i<=periods;i++){
    const profit=balance*ratePerPeriod;
    balance+=profit+add;
    totalInvested+=add;
    const timeLabel=unit.perYear===1?`${i} 年末`:unit.perYear===12?`第 ${i} 個月`:`第 ${i} 週`;
    const tr=document.createElement('tr');
    if(i===periods) tr.className='highlight';
    tr.innerHTML=`<td>${i}</td><td>${timeLabel}</td><td>${fmt(balance-profit-add)}</td><td>${fmt(add)}</td><td>${fmt(profit)}</td><td>${fmt(balance)}</td>`;
    fragment.appendChild(tr);
  }

  const final=Math.round(balance);
  const totalProfit=final-totalInvested;
  $('result').innerHTML=`${periods} ${unit.text} 後，資產預計：<br><span id="finalNum">${fmt(final)}</span>`;
  $('tbody').innerHTML=''; $('tbody').appendChild(fragment);
  $('tbody').innerHTML+=`
    <tr class="summary-row"><td colspan="2">總投入本金</td><td colspan="4">${fmt(totalInvested)}</td></tr>
    <tr class="summary-row"><td colspan="2">總收益（複利）</td><td colspan="4">${fmt(totalProfit)} ➤ 回報率 ${((totalProfit/totalInvested)*100).toFixed(2)}%</td></tr>`;
  $('tableContainer').style.display='block';
}

// 反向計算
function reverseCalc() {
  save(); fmtCache.clear();

  const initial = Math.max(0, +($('initial').value) || 0);
  let annualRate = (+($('rate').value) || 0) / 100;
  if (annualRate <= 0) annualRate = 0.0001;
  const fullAdd = Math.max(0, +($('periodicAdd').value) || 0);
  let target = +($('targetAmount').value);
  if (!target || target <= initial) {
    $('result').innerHTML = '目標需大於目前資產';
    return;
  }

  const unit = unitInfo[$('timeUnit').value];
  const rate = annualRate / unit.rateDiv;
  const perYear = unit.perYear;

  let balance = initial;
  let totalInvested = initial;
  let period = 0;

  while (balance < target) {
    const nextBalance = balance * (1 + rate) + fullAdd;
    if (nextBalance >= target) break;
    balance = nextBalance;
    totalInvested += fullAdd;
    period++;
  }

  const remaining = target - balance * (1 + rate);
  const lastAdd = remaining > 0 ? Math.max(0, Math.round(remaining)) : 0;

  if (lastAdd > 0) {
    balance = balance * (1 + rate) + lastAdd;
    totalInvested += lastAdd;
    period++;
  } else {
    balance = balance * (1 + rate);
  }

  const profit = Math.round(balance - totalInvested);
  const years = period / perYear;

  const timeStr = perYear === 1 ? `${years.toFixed(1)} 年` :
    perYear === 12 ? `${period} 個月（約 ${years.toFixed(1)} 年）` :
      `${period} 週（約 ${years.toFixed(1)} 年）`;

  const lastAddText = (lastAdd > 0 && lastAdd < fullAdd)
    ? `<br>→ 第 ${period} 期只需投入 <b style="font-size:1.5em;color:var(--accent)">${fmt(lastAdd)}</b>（而非 ${fmt(fullAdd)}）`
    : '';

  $('result').innerHTML = `
    <div style="font-size:1.8rem;line-height:1.8;">
      達成 <span style="color:var(--accent)">${fmt(target)}</span> 目標<br>
      <b style="font-size:2.4rem;color:var(--accent-l)">約 ${timeStr}</b>
      ${lastAddText}
      <br><br>
      總投入本金：${fmt(totalInvested)}<br>
      總收益：${fmt(profit)} 
      <span style="color:var(--accent)">(回報 ${(profit / totalInvested * 100).toFixed(1)}%)</span>
    </div>`;

  $('tableContainer').style.display = 'none';
}

// 初始化與事件
load(); calc();
const debounce=(fn,delay=150)=>{let t;return()=>{clearTimeout(t);t=setTimeout(fn,delay);};};
['initial','rate','timeValue','periodicAdd','currency','timeUnit'].forEach(id=>$(id).addEventListener('input',debounce(calc)));
$('targetAmount').addEventListener('input',()=>{if($('targetAmount').value)$('result').innerHTML='點擊下方按鈕計算所需時間';});
$('normalCalc').onclick=calc;
$('reverseCalc').onclick=reverseCalc;
$('darkBtn').onclick=()=>{document.body.classList.toggle('dark');save();};

// 按鈕波紋
const ripple=btn=>btn.addEventListener('click',e=>{
  const rect=btn.getBoundingClientRect();
  btn.style.setProperty('--ripple-x',(e.clientX-rect.left)+'px');
  btn.style.setProperty('--ripple-y',(e.clientY-rect.top)+'px');
  btn.classList.add('clicked');
  setTimeout(()=>btn.classList.remove('clicked'),600);
});
ripple($('normalCalc')); ripple($('reverseCalc'));

// === 數字鍵盤 ===
let activeInput=null;
const showPad=input=>{
  input.blur(); activeInput=input; input.classList.add('active');
  $('numPad').classList.add('show');
  setTimeout(()=>{try{const range=document.createRange();const sel=window.getSelection();range.selectNodeContents(input);sel.removeAllRanges();sel.addRange(range);}catch(e){}},50);
};
const hidePad=()=>{if(activeInput){activeInput.classList.remove('active');activeInput.blur();} activeInput=null;$('numPad').classList.remove('show');};

document.querySelectorAll('#initial,#rate,#periodicAdd,#timeValue,#targetAmount').forEach(inp=>{
  inp.addEventListener('click',e=>{e.preventDefault();e.stopPropagation();showPad(inp);});
  inp.addEventListener('focus',e=>{e.preventDefault();inp.blur();});
});

document.querySelectorAll('.pad-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(!activeInput) return;
    let v=activeInput.value||'';
    const key=btn.textContent;
    if(key==='backspace') v=v.slice(0,-1);
    else if(btn.classList.contains('done')){hidePad();return;}
    else if(key==='000') v+='000';
    else if(key==='00') v+='00';
    else v+=key;
    if(v && v!=='.' && v!=='0.') v=parseFloat(v)+'';
    activeInput.value=v;
    activeInput.dispatchEvent(new Event('input'));
  });
});

// === 夢幻流體粒子動態背景（2025 最新超省電版）===
(()=>{const canvas=document.getElementById('fluid-bg'),ctx=canvas.getContext('2d');
let w,h,t=0;
const resize=()=>{w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;};
resize();window.addEventListener('resize',resize);

const particles=[], count=document.body.classList.contains('dark')?45:60;
class Particle{constructor(){this.reset();}
reset(){this.x=Math.random()*w;this.y=Math.random()*h;this.vx=(Math.random()-0.5)*0.6;this.vy=(Math.random()-0.5)*0.6;this.r=Math.random()*3+2;}
update(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>w)this.vx*=-1;if(this.y<0||this.y>h)this.vy*=-1;}}

for(let i=0;i<count;i++) particles.push(new Particle());

const draw=()=>{
  ctx.clearRect(0,0,w,h); t+=0.008;
  const isDark = document.body.classList.contains('dark');
  const color = isDark ? '255,141,61' : '255,109,0';
  const lineColor = isDark ? 180 : 109;

  particles.forEach(p=>{p.update();
    const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*3);
    grad.addColorStop(0,`rgba(${color},0.9)`);
    grad.addColorStop(1,'rgba(255,109,0,0)');
    ctx.fillStyle=grad;
    ctx.fillRect(p.x-p.r*3,p.y-p.r*3,p.r*6,p.r*6);

    particles.forEach(q=>{if(p===q)return;
      const dx=p.x-q.x, dy=p.y-q.y, dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<140){
        ctx.beginPath();
        ctx.strokeStyle=`rgba(255,${lineColor},0,${0.22*(1-dist/140)})`;
        ctx.lineWidth=1.5; ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke();
      }
    });
  });
};

const loop=()=>{draw(); requestAnimationFrame(loop);};
loop();

// 暗黑模式切換時自動更新粒子顏色
const observer = new MutationObserver(() => { particles.length=0; const c=document.body.classList.contains('dark')?45:60; for(let i=0;i<c;i++)particles.push(new Particle()); });
observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
})();
</script>
</body>
</html>
