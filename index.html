<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>資產複利增長計算器 - 終極版</title>
<style>
  :root{--bg:#f0f8ff;--card:rgba(255,255,255,0.96);--text:#0a2d4a;--input:#fff;--accent:#ff6d00;--accent-l:#ff8a3d;}
  body.dark{--bg:#0a1422;--card:rgba(15,25,45,0.97);--text:#e3f2fd;--input:rgba(40,60,100,0.9);--accent:#ff8a3d;--accent-l:#ffb74d;}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  body{
    font-family:"SF Pro TC","Microsoft JhengHei",sans-serif;
    background:linear-gradient(135deg,#a7e1f5,var(--bg));
    color:var(--text);
    min-height:100vh;
    padding:20px 0;
    transition:.6s;
  }
  .container{
    max-width:1000px;
    margin:0 auto;
    background:var(--card);
    border-radius:32px;
    padding:40px 20px 60px;
    box-shadow:0 25px 80px rgba(0,0,0,.18);
    backdrop-filter:blur(20px);
  }
  h1{
    font-size:2.4rem;
    font-weight:900;
    background:linear-gradient(90deg,var(--accent),var(--accent-l));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    text-align:center;
    margin-bottom:8px;
  }
  .subtitle{
    text-align:center;
    font-size:1rem;
    opacity:.9;
    margin-bottom:30px;
  }
  .controls{
    display:flex;
    justify-content:center;
    gap:12px;
    flex-wrap:wrap;
    margin:30px 0 25px;
  }
  select,.mode-btn{
    padding:11px 20px;
    border:none;
    border-radius:50px;
    background:var(--input);
    color:var(--text);
    font-size:15px;
    font-weight:600;
    min-width:120px;
  }
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap:18px;
    margin:35px 12px;
  }
  label{
    font-weight:700;
    color:var(--accent);
    font-size:0.95rem;
    margin-bottom:8px;
    display:block;
  }
  input{
    width:100%;
    height:56px;
    padding:0 18px;
    font-size:1.1rem;
    font-weight:600;
    border:none;
    border-radius:18px;
    background:var(--input);
    box-shadow:0 8px 25px rgba(0,0,0,.1);
  }
  .calc-btn{
    display:block;
    margin:45px auto 40px;
    padding:18px 60px;
    font-size:1.55rem;
    font-weight:900;
    color:#fff;
    background:linear-gradient(45deg,var(--accent),var(--accent-l));
    border:none;
    border-radius:50px;
    box-shadow:0 15px 40px rgba(255,109,0,.5);
    cursor:pointer;
  }
  #result{
    text-align:center;
    font-size:2.1rem;
    font-weight:900;
    margin:30px 20px;
    line-height:1.6;
  }
  #finalNum{
    background:linear-gradient(90deg,var(--accent),var(--accent-l));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    font-size:1.35em;
  }
  .table-container{
    margin:20px 10px 40px;
    border-radius:20px;
    overflow:hidden;
    box-shadow:0 15px 40px rgba(0,0,0,.18);
  }
  .table-wrapper{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  table{
    width:100%;
    min-width:660px;
    border-collapse:collapse;
    background:var(--input);
  }
  th{
    background:linear-gradient(90deg,var(--accent),var(--accent-l));
    color:white;
    padding:16px 10px;
    font-size:0.95rem;
    white-space:nowrap;
  }
  td{
    padding:14px 10px;
    text-align:right;
    font-size:0.95rem;
    white-space:nowrap;
  }
  tr:nth-child(even){background:rgba(0,0,0,.04);}
  body.dark tr:nth-child(even){background:rgba(255,255,255,.06);}
  .highlight td{
    font-weight:900;
    font-size:1.05em;
    background:rgba(255,109,0,.18)!important;
    color:var(--accent);
  }
  .summary-row{
    font-weight:900 !important;
    color:var(--accent) !important;
  }
  body.dark .summary-row{
    background:rgba(255,141,61,.25) !important;
  }

  @media(max-width:480px){
    .container{padding:35px 16px 50px;}
    h1{font-size:2.1rem;}
    #result{font-size:1.85rem;}
    input{height:52px;font-size:1rem;}
    .calc-btn{padding:16px 50px;font-size:1.45rem;}
  }

  /* 只要加入這段即可（放在你原本的 <style> 裡面任意位置） */
  .calc-btn, #reverseCalc {
    position: relative;
    overflow: hidden;
    transition: transform .2s;
  }
  .calc-btn:active, #reverseCalc:active {
    transform: scale(0.94);
  }
  .calc-btn::after, #reverseCalc::after {
    content: '';
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,.5);
    width: 0; height: 0;
    left: var(--ripple-x, 50%);
    top: var(--ripple-y, 50%);
    transform: translate(-50%, -50%);
    pointer-events: none;
    opacity: 0;
  }
  .calc-btn.clicked::after, #reverseCalc.clicked::after {
    animation: ripple 0.6s ease-out;
    width: 300px;
    height: 300px;
    opacity: 0;
  }
  @keyframes ripple {
    to { width: 300px; height: 300px; opacity: 0; }
  }
  
</style>
</head>
<body>

<div class="container">
  <h1>資產複利增長計算器</h1>
  <p class="subtitle">財富從現在開始看見</p>

  <div class="controls">
    <select id="currency"><option value="HKD">HK$ 港幣</option><option value="USD">USD 美金</option></select>
    <select id="timeUnit"><option value="year">年</option><option value="month">個月</option><option value="week">週</option></select>
    <button class="mode-btn" id="darkBtn">暗黑模式</button>
  </div>

  <div class="grid">
    <div><label>當前資產</label><input type="number" id="initial" min="0" value="500000"></div>
    <div><label>預期年回報率 (%)</label><input type="number" id="rate" step="0.1" value="8"></div>
    <div><label>每期定投金額</label><input type="number" id="periodicAdd" min="0" value="10000"></div>
    <div><label>預測時間（正向）</label><input type="number" id="timeValue" min="1" value="20"></div>
    <div><label>目標資產（反向）</label><input type="number" id="targetAmount" min="1" value="10000000" placeholder="例如 1000萬"></div>
    <div style="display:flex; align-items:end;">
      <button class="calc-btn" id="reverseCalc" style="margin:0; padding:16px 20px; font-size:1.3rem; width:100%;">
        計算需要多久達到目標
      </button>
    </div>
  </div>

  <button class="calc-btn" id="normalCalc">立即計算詳細報表(正向)</button>
  
  <div id="result">請選擇模式開始計算</div>
  
  <div class="table-container" id="tableContainer" style="display:none;">
    <div class="table-wrapper">
      <table>
        <<thead>
          <tr>
            <th>期數</th>
            <th>時間</th>
            <th>期初金額</th>
            <th>本期投入</th>
            <th>本期收益</th>
            <th>期末金額</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const C = {HKD:{s:'HK$',r:1}, USD:{s:'US$',r:7.8}};
const $ = id=>document.getElementById(id);

function fmt(n){
  const cur = $('currency').value;
  const val = cur==='USD' ? Math.round(n/7.8) : Math.round(n);
  return C[cur].s + val.toLocaleString('en-HK');
}
function unitText(){return {year:'年',month:'個月',week:'週'}[$('timeUnit').value];}

function save(){
  localStorage.setItem('w', JSON.stringify({
    initial:$('initial').value, rate:$('rate').value, timeValue:$('timeValue').value,
    periodicAdd:$('periodicAdd').value, targetAmount:$('targetAmount').value,
    currency:$('currency').value, timeUnit:$('timeUnit').value,
    dark:document.body.classList.contains('dark')
  }));
}
function load(){
  const d = JSON.parse(localStorage.getItem('w')||'null');
  if(d){
    $('initial').value = d.initial??500000;
    $('rate').value = d.rate??8;
    $('timeValue').value = d.timeValue??20;
    $('periodicAdd').value = d.periodicAdd??10000;
    $('targetAmount').value = d.targetAmount??10000000;
    $('currency').value = d.currency??'HKD';
    $('timeUnit').value = d.timeUnit??'year';
    if(d.dark) document.body.classList.add('dark');
  }
}

// 正向計算
function calc(){ /* 和上面完全一樣的 calc 函數，省略以節省篇幅 */ 
  save();
  const initial = Math.max(0, +$('initial').value||0);
  const annualRate = (+$('rate').value||0)/100;
  const timeValue = Math.max(1, +$('timeValue').value||1);
  const add = Math.max(0, +$('periodicAdd').value||0);
  const unit = $('timeUnit').value;

  const ratePerPeriod = unit==='week' ? annualRate/52 : annualRate/12;
  const periods = unit==='year' ? timeValue * 12 : unit==='month' ? timeValue : timeValue * 52;

  let balance = initial;
  const rows = [];
  let totalInvested = initial;

  rows.push({period:0, time:'起始', start:initial, invest:0, profit:0, end:initial});

  for(let i=1; i<=periods; i++){
    const start = balance;
    const profit = balance * ratePerPeriod;
    balance = start + profit + add;
    totalInvested += add;

    let show = false;
    let timeLabel = '';
    if(unit==='year'){
      show = i%12===0 || i===periods;
      timeLabel = i%12===0 ? `${i/12} 年末` : '最後一期';
    }else if(unit==='month'){
      show = i%12===0 || i===periods;
      timeLabel = i%12===0 ? `${i/12} 年末` : `第 ${i} 個月`;
    }else{
      show = i%52===0 || i===periods;
      timeLabel = i%52===0 ? `${i/52} 年末` : `第 ${i} 週`;
    }

    if(show || periods<=24){
      rows.push({
        period:i, time:timeLabel||`第 ${i} 期`,
        start:Math.round(start), invest:add, profit:Math.round(profit), end:Math.round(balance)
      });
    }
  }

  const final = Math.round(balance);
  const totalProfit = final - totalInvested;

  $('result').innerHTML = `${timeValue} ${unitText()} 後，資產預計：<br><span id="finalNum">${fmt(final)}</span>`;

  const tbody = $('tbody');
  tbody.innerHTML = '';
  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    if(idx===rows.length-1) tr.classList.add('highlight');
    tr.innerHTML = `<td>${r.period===0?'—':r.period}</td><td>${r.time}</td><td>${fmt(r.start)}</td><td>${fmt(r.invest)}</td><td>${fmt(r.profit)}</td><td>${fmt(r.end)}</td>`;
    tbody.appendChild(tr);
  });

  // 總結行（暗黑模式也超清楚！）
  tbody.innerHTML += `
    <tr class="summary-row" style="background:rgba(255,109,0,.12);"><td colspan="2">總投入本金</td><td colspan="4">${fmt(totalInvested)}</td></tr>
    <tr class="summary-row" style="background:rgba(255,109,0,.25);"><td colspan="2">總收益（複利）</td><td colspan="4">${fmt(totalProfit)} ➤ 回報率 ${((totalProfit/totalInvested)*100).toFixed(2)}%</td></tr>
  `;

  $('tableContainer').style.display = 'block';
}

// 反向計算（已修所有 bug）
function reverseCalc(){
  save();
  const initial = Math.max(0, +$('initial').value||0);
  let annualRate = (+$('rate').value||0)/100;
  if(annualRate <= 0) annualRate = 0.0001; // 防止 0% 無限迴圈
  const add = Math.max(0, +$('periodicAdd').value||0);
  let target = +$('targetAmount').value;
  if(!target || target <= initial){
    $('result').innerHTML = '請輸入大於目前資產的目標金額';
    return;
  }
  const unit = $('timeUnit').value;
  const ratePerPeriod = unit==='week' ? annualRate/52 : annualRate/12;

  let balance = initial;
  let period = 0;
  let totalInvested = initial;

  while(balance < target){
    balance = balance * (1 + ratePerPeriod) + add;
    totalInvested += add;
    period++;
    if(period > 10000){
      $('result').innerHTML = '無法在合理時間內達成<br>請提高回報率或定投金額';
      return;
    }
  }

  const years = unit==='year' ? period/12 : unit==='month' ? period/12 : period/52;
  const displayYears = unit==='year' ? period/12 : unit==='month' ? period : Math.ceil(period/52);

  const timeStr = unit==='year' ? `${displayYears.toFixed(1)} 年` :
                  unit==='month' ? `${period} 個月（約 ${years.toFixed(1)} 年）` :
                                   `${period} 週（約 ${years.toFixed(1)} 年）`;

  const final = Math.round(balance);
  const profit = final - totalInvested;

  $('result').innerHTML = `
    <div style="font-size:1.8rem;line-height:1.7;">
      達成 <span style="font-size:1.3em;color:var(--accent)">${fmt(target)}</span>目標<br>
      <b style="font-size:2.4rem;color:var(--accent-l)">約 ${timeStr}</b><br><br>
      總投入本金：${fmt(totalInvested)}<br>
      總收益：${fmt(profit)} 
      <span style="color:var(--accent)">（回報 ${(profit/totalInvested*100).toFixed(1)}%）</span>
    </div>
  `;
  $('tableContainer').style.display = 'none';
}

load();
calc();

$('normalCalc').onclick = calc;
$('reverseCalc').onclick = reverseCalc;

document.querySelectorAll('#initial,#rate,#timeValue,#periodicAdd,#currency,#timeUnit').forEach(el=>el.addEventListener('input',calc));
$('targetAmount').addEventListener('input',()=>{if($('targetAmount').value)$('result').innerHTML='點擊下方按鈕計算所需時間';});
$('#darkBtn').onclick=()=>{document.body.classList.toggle('dark');save();};

const addClickEffect = btn => {
  btn.addEventListener('click', function(e) {
    const rect = this.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    this.style.setProperty('--ripple-x', x + 'px');
    this.style.setProperty('--ripple-y', y + 'px');
    this.classList.add('clicked');
    setTimeout(() => this.classList.remove('clicked'), 600);
  });
};

addClickEffect(document.getElementById('normalCalc'));
addClickEffect(document.getElementById('reverseCalc'));
</script>
</body>
</html>
